<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="parser.js"></script>
</head>
<body>
    <script>
        let parser = new Parser();

        /*
        function optimizeValue(val, allow=["number", "boolean", "string", "object"], fallback=window["String"]) {
            if (typeof val == "string" && "number" in allow) {
               let nval = parseFloat(val);
               if (nval !== NaN ) {
                   val = nval;
               }
            }

            if (allow.some((t) => typeof val === t)) {
                return val;
            }

            if (typeof fallback == "function") {
                return fallback(val);
            }

            return fallback;
        }
        */

        class Logics {
            constructor(s) {
                this.ast = parser.parse(s);
            }

            run(values) {
                let stack = [];
                this.traverse(this.ast, stack, values || {});
                console.log(stack);
            }

            /**
             * Convert to JavaScript type into Logics string representation.
             *
             * @param value
             * @returns {string}
             */
            stringValue(value) {
                switch (value) {
                    case null:
                    case undefined:
                        return "None"
                    case true:
                        return "True";
                    case false:
                        return "False";
                    default:
                        return value.toString()
                }
            }

            /**
             * General traversal function.
             *
             * This function performs pre, loop or pass and post operations.
             * @param node
             * @param stack
             * @param values
             */
            traverse(node, stack, values) {
                let fn;

                if ((fn = this["pre_" + node.emit]) !== undefined) {
                    fn.call(this, node, stack, values);
                }

                if ((fn = this["loop_" + node.emit]) !== undefined) {
                    fn.call(this, node, stack, values);
                }
                else if (node.children !== undefined) {
                    let fn = this["pass_" + node.emit];

                    for (let child of node.children) {
                        this.traverse(child, stack, values);

                        if (fn !== undefined) {
                            fn.call(this, node, stack, values);
                        }
                    }
                }

                if ((fn = this["post_" + node.emit]) !== undefined) {
                    fn.call(this, node, stack, values);
                }
            }

            post_STRING(node, stack) {
                // Cut "..." from string.
                stack.push(node.match.substring(1, node.match.length - 1));
            }

            post_NUMBER(node, stack) {
                stack.push(parseFloat(node.match));
            }

            post_add(node, stack) {
                let b = stack.pop();
                let a = stack.pop();

                if (typeof a == "string" || typeof b == "string") {
                    a = this.stringValue(a);
                    b = this.stringValue(b);
                }

                stack.push(a + b);
            }

            post_mul(node, stack) {
                let b = stack.pop();
                let a = stack.pop();

                if (typeof a == "string") {
                    stack.push(a.repeat(parseInt(b)));
                }
                else if (typeof b == "string") {
                    stack.push(b.repeat(parseInt(a)));
                }
                else {
                    stack.push(a * b);
                }
            }

            post_sub(node, stack) {
                let b = stack.pop();
                let a = stack.pop();
                stack.push(a - b);
            }

            post_div(node, stack) {
                let b = stack.pop();
                let a = stack.pop();
                stack.push(a / b);
            }

            post_True(_, stack) {
                stack.push(true);
            }

            post_False(_, stack) {
                stack.push(true);
            }
        }

        let calc = new Logics("'Hello World' * 3 + (1 + 2 * 3 + 4) + True");
        calc.run();
    </script>
</body>
</html>